<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>To'lov - Elbek Design Studio</title>
  <link rel="icon" href="/img/36cc6850-12bc-4bd8-8721-4833a90f2da8.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- QR Code Scanner Library -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #8b5cf6;
      --accent: #06b6d4;
      --dark: #0f172a;
      --light: #f8fafc;
      --gray: #64748b;
      --white: #ffffff;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
      --gradient: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      --shadow: 0 10px 40px rgba(99, 102, 241, 0.1);
      --shadow-hover: 0 20px 60px rgba(99, 102, 241, 0.2);
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--light);
      line-height: 1.6;
      color: var(--dark);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--white);
      box-shadow: var(--shadow);
      padding: 1rem 0;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      backdrop-filter: blur(20px);
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2rem;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: 3px solid var(--primary);
    }

    .brand-name {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .back-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: rgba(99, 102, 241, 0.1);
      color: var(--primary);
      text-decoration: none;
      border-radius: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: var(--primary);
      color: var(--white);
      transform: translateY(-2px);
    }

    /* Main Content */
    .main {
      margin-top: 100px;
      padding: 2rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    .page-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 1rem;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .page-subtitle {
      color: var(--gray);
      font-size: 1.1rem;
      font-weight: 300;
    }

    /* Payment Container */
    .payment-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .payment-card {
      background: var(--white);
      border-radius: 2rem;
      padding: 2rem;
      box-shadow: var(--shadow);
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 1.5rem;
    }

    /* Order Summary */
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .order-item:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--primary);
    }

    .order-label {
      color: var(--gray);
    }

    .order-value {
      font-weight: 600;
    }

    /* Payment Methods */
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .payment-method {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1.5rem;
      border: 2px solid #e5e7eb;
      border-radius: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .payment-method:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.02);
    }

    .payment-method.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .payment-icon {
      font-size: 2rem;
    }

    .payment-info h4 {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .payment-info p {
      color: var(--gray);
      font-size: 0.9rem;
    }

    /* Payment Details */
    .payment-details {
      margin-top: 2rem;
      padding: 2rem;
      background: var(--light);
      border-radius: 1.5rem;
      display: none;
    }

    .payment-details.active {
      display: block;
    }

    .card-number {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary);
      background: var(--white);
      padding: 1rem;
      border-radius: 0.75rem;
      text-align: center;
      margin: 1rem 0;
      border: 2px dashed var(--primary);
    }

    .qr-code {
      text-align: center;
      margin: 1.5rem 0;
    }

    .qr-code img {
      max-width: 200px;
      border-radius: 1rem;
      box-shadow: var(--shadow);
    }

    /* Upload Section */
    .upload-section {
      background: var(--white);
      border-radius: 2rem;
      padding: 2rem;
      box-shadow: var(--shadow);
      margin-top: 2rem;
    }

    .upload-area {
      border: 3px dashed #d1d5db;
      border-radius: 1.5rem;
      padding: 3rem 2rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.02);
    }

    .upload-area.dragover {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .upload-icon {
      font-size: 3rem;
      color: var(--gray);
      margin-bottom: 1rem;
    }

    .upload-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.5rem;
    }

    .upload-hint {
      color: var(--gray);
      font-size: 0.9rem;
    }

    .file-input {
      display: none;
    }

    /* Camera Section */
    .camera-section {
      margin-top: 1rem;
      text-align: center;
    }

    .camera-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      background: var(--secondary);
      color: var(--white);
      border: none;
      border-radius: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .camera-btn:hover {
      background: var(--primary);
      transform: translateY(-2px);
    }

    #cameraModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .camera-modal-content {
      background: var(--white);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    #cameraVideo {
      width: 100%;
      max-width: 400px;
      border-radius: 1rem;
      margin: 1rem 0;
    }

    .camera-controls {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }

    .camera-controls button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .capture-btn {
      background: var(--success);
      color: var(--white);
    }

    .capture-btn:hover {
      background: #16a34a;
    }

    .cancel-btn {
      background: var(--error);
      color: var(--white);
    }

    .cancel-btn:hover {
      background: #dc2626;
    }

    /* Preview Section */
    .preview-section {
      display: none;
      margin-top: 2rem;
      text-align: center;
    }

    .preview-image {
      max-width: 300px;
      width: 100%;
      border-radius: 1rem;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }

    .preview-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .preview-actions button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .confirm-btn {
      background: var(--success);
      color: var(--white);
    }

    .confirm-btn:hover {
      background: #16a34a;
    }

    .retake-btn {
      background: var(--warning);
      color: var(--white);
    }

    .retake-btn:hover {
      background: #d97706;
    }

    /* Loading Animation */
    .loading {
      display: none;
      text-align: center;
      padding: 2rem;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Success Message */
    .success-message {
      display: none;
      background: var(--success);
      color: var(--white);
      padding: 2rem;
      border-radius: 1.5rem;
      text-align: center;
      margin-top: 2rem;
      box-shadow: var(--shadow);
    }

    .success-message h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    /* Error Message */
    .error-message {
      display: none;
      background: var(--error);
      color: var(--white);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
      margin-top: 1rem;
    }

    /* QR Scanner */
    .qr-scanner {
      margin-top: 2rem;
      text-align: center;
    }

    .qr-scanner-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem 2rem;
      background: var(--accent);
      color: var(--white);
      border: none;
      border-radius: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }

    .qr-scanner-btn:hover {
      background: #0891b2;
      transform: translateY(-2px);
    }

    #qrScannerModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .qr-scanner-content {
      background: var(--white);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
    }

    #qrVideo {
      width: 100%;
      max-width: 400px;
      border-radius: 1rem;
      margin: 1rem 0;
    }

    .qr-result {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--light);
      border-radius: 0.75rem;
      display: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        padding: 0 1rem;
      }

      .main {
        padding: 1rem;
      }

      .page-title {
        font-size: 2rem;
      }

      .payment-container {
        grid-template-columns: 1fr;
      }

      .payment-card {
        padding: 1.5rem;
      }

      .upload-section {
        padding: 1.5rem;
      }

      .upload-area {
        padding: 2rem 1rem;
      }

      .camera-modal-content,
      .qr-scanner-content {
        margin: 1rem;
        width: calc(100% - 2rem);
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <img src="/img/36cc6850-12bc-4bd8-8721-4833a90f2da8.png" alt="Logo" class="logo">
        <div class="brand-name">Elbek Design Studio</div>
      </div>
      <a href="/index.html" class="back-btn">
        <span>←</span> Orqaga
      </a>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <div class="page-header">
      <h1 class="page-title">💳 To'lov</h1>
      <p class="page-subtitle">Buyurtmangiz uchun to'lovni amalga oshiring</p>
    </div>

    <!-- Payment Container -->
    <div class="payment-container">
      <!-- Order Summary -->
      <div class="payment-card">
        <h3 class="card-title">
          <span>📋</span> Buyurtma ma'lumotlari
        </h3>
        <div id="orderSummary">
          <!-- Order details will be populated by JavaScript -->
        </div>
      </div>

      <!-- Payment Methods -->
      <div class="payment-card">
        <h3 class="card-title">
          <span>💳</span> To'lov usuli
        </h3>
        <div class="payment-methods">
          <div class="payment-method active" data-method="uzcard">
            <div class="payment-icon">💳</div>
            <div class="payment-info">
              <h4>UzCard</h4>
              <p>Bank kartasi orqali to'lov</p>
            </div>
          </div>
          <div class="payment-method" data-method="humo">
            <div class="payment-icon">🏦</div>
            <div class="payment-info">
              <h4>Humo</h4>
              <p>Humo kartasi orqali to'lov</p>
            </div>
          </div>
          <div class="payment-method" data-method="payme">
            <div class="payment-icon">📱</div>
            <div class="payment-info">
              <h4>Payme</h4>
              <p>Payme ilovasi orqali to'lov</p>
            </div>
          </div>
        </div>

        <!-- Payment Details -->
        <div class="payment-details active" id="uzcard-details">
          <h4>💳 UzCard orqali to'lov</h4>
          <p>Quyidagi karta raqamiga to'lov qiling:</p>
          <div class="card-number">8600 1234 5678 9012</div>
          <p><strong>Karta egasi:</strong> Elbek Karimov</p>
          <p><strong>Bank:</strong> Xalq Banki</p>
        </div>

        <div class="payment-details" id="humo-details">
          <h4>🏦 Humo orqali to'lov</h4>
          <p>Quyidagi karta raqamiga to'lov qiling:</p>
          <div class="card-number">9860 1234 5678 9012</div>
          <p><strong>Karta egasi:</strong> Elbek Karimov</p>
          <p><strong>Bank:</strong> Milliy Bank</p>
        </div>

        <div class="payment-details" id="payme-details">
          <h4>📱 Payme orqali to'lov</h4>
          <p>Payme ilovasida quyidagi raqamga to'lov qiling:</p>
          <div class="card-number">+998 90 123 45 67</div>
          <div class="qr-code">
            <img src="/img/misoluchunchek.jpg" alt="Payme QR Code">
            <p>QR kodni skanerlang</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <h3 class="card-title">
        <span>📤</span> To'lov chekini yuklang
      </h3>
      
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">📷</div>
        <div class="upload-text">To'lov chekini yuklang</div>
        <div class="upload-hint">Rasm faylini bu yerga sudrab olib keling yoki bosing (maksimal 50MB)</div>
        <input type="file" id="fileInput" class="file-input" accept="image/*" capture="environment">
      </div>

      <!-- Camera Section -->
      <div class="camera-section">
        <button class="camera-btn" id="cameraBtn">
          <span>📸</span> Kamera bilan suratga olish
        </button>
      </div>

      <!-- QR Scanner -->
      <div class="qr-scanner">
        <button class="qr-scanner-btn" id="qrScannerBtn">
          <span>🔍</span> QR kod skanerlash
        </button>
      </div>

      <!-- Preview Section -->
      <div class="preview-section" id="previewSection">
        <h4>📷 Yuklangan rasm:</h4>
        <img id="previewImage" class="preview-image" alt="Preview">
        <div class="preview-actions">
          <button class="confirm-btn" id="confirmBtn">✅ Tasdiqlash</button>
          <button class="retake-btn" id="retakeBtn">🔄 Qayta olish</button>
        </div>
      </div>

      <!-- Error Message -->
      <div class="error-message" id="errorMessage">
        ❌ Faqat to'lov cheklari qabul qilinadi! Iltimos, to'g'ri chek rasmini yuklang.
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <p>Chek yuborilmoqda...</p>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">
      <h3>✅ To'lov cheki muvaffaqiyatli yuborildi!</h3>
      <p>Chekingiz tekshirilmoqda. Tez orada sizga javob beramiz.</p>
    </div>
  </main>

  <!-- Camera Modal -->
  <div id="cameraModal">
    <div class="camera-modal-content">
      <h3>📸 Chekni suratga oling</h3>
      <video id="cameraVideo" autoplay playsinline></video>
      <canvas id="cameraCanvas" style="display: none;"></canvas>
      <div class="camera-controls">
        <button class="capture-btn" id="captureBtn">📷 Suratga olish</button>
        <button class="cancel-btn" id="cancelCameraBtn">❌ Bekor qilish</button>
      </div>
    </div>
  </div>

  <!-- QR Scanner Modal -->
  <div id="qrScannerModal">
    <div class="qr-scanner-content">
      <h3>🔍 QR kod skanerlash</h3>
      <video id="qrVideo" autoplay playsinline></video>
      <canvas id="qrCanvas" style="display: none;"></canvas>
      <div class="qr-result" id="qrResult">
        <h4>✅ QR kod topildi:</h4>
        <p id="qrData"></p>
      </div>
      <div class="camera-controls">
        <button class="cancel-btn" id="cancelQrBtn">❌ Yopish</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import Firebase functions
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA_B0OC6Y91ontwJWM-o615jg7Dr5jUVvA",
      authDomain: "dizaynowner.firebaseapp.com",
      databaseURL: "https://dizaynowner-default-rtdb.firebaseio.com/",
      projectId: "dizaynowner",
      storageBucket: "dizaynowner.firebasestorage.app",
      messagingSenderId: "976762018041",
      appId: "1:976762018041:web:e43227005165059158ea28",
      measurementId: "G-0S6KV8DFKJ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // Telegram Bot Configuration
    const TELEGRAM_BOT_TOKEN = '7729692495:7606592691:AAEX0POICKvjbOEwNQuAdUn-wqcqKdl-Gvc';
    const TELEGRAM_CHAT_ID = '7833115003';

    let currentOrder = null;
    let selectedFile = null;
    let cameraStream = null;
    let qrStream = null;

    // Load order data
    function loadOrderData() {
      const orderData = sessionStorage.getItem('currentOrder');
      if (orderData) {
        currentOrder = JSON.parse(orderData);
        displayOrderSummary();
      } else {
        // Redirect back if no order data
        window.location.href = '/index.html';
      }
    }

    // Display order summary
    function displayOrderSummary() {
      const orderSummary = document.getElementById('orderSummary');
      
      if (currentOrder.type === 'gaming') {
        orderSummary.innerHTML = `
          <div class="order-item">
            <span class="order-label">👤 Mijoz:</span>
            <span class="order-value">${currentOrder.user}</span>
          </div>
          <div class="order-item">
            <span class="order-label">📧 Email:</span>
            <span class="order-value">${currentOrder.email}</span>
          </div>
          <div class="order-item">
            <span class="order-label">📱 Telefon:</span>
            <span class="order-value">${currentOrder.phone}</span>
          </div>
          ${currentOrder.telegram ? `
          <div class="order-item">
            <span class="order-label">💬 Telegram:</span>
            <span class="order-value">${currentOrder.telegram}</span>
          </div>
          ` : ''}
          <div class="order-item">
            <span class="order-label">🎮 O'yin:</span>
            <span class="order-value">${currentOrder.game}</span>
          </div>
          <div class="order-item">
            <span class="order-label">🎨 Dizayn turi:</span>
            <span class="order-value">${currentOrder.designType}</span>
          </div>
          <div class="order-item">
            <span class="order-label">💰 Jami narx:</span>
            <span class="order-value">${currentOrder.price.toLocaleString()} so'm</span>
          </div>
        `;
      } else {
        orderSummary.innerHTML = `
          <div class="order-item">
            <span class="order-label">👤 Mijoz:</span>
            <span class="order-value">${currentOrder.user}</span>
          </div>
          <div class="order-item">
            <span class="order-label">📧 Email:</span>
            <span class="order-value">${currentOrder.email}</span>
          </div>
          <div class="order-item">
            <span class="order-label">📱 Telefon:</span>
            <span class="order-value">${currentOrder.phone}</span>
          </div>
          ${currentOrder.telegram ? `
          <div class="order-item">
            <span class="order-label">💬 Telegram:</span>
            <span class="order-value">${currentOrder.telegram}</span>
          </div>
          ` : ''}
          <div class="order-item">
            <span class="order-label">🏢 Kompaniya:</span>
            <span class="order-value">${currentOrder.companyName}</span>
          </div>
          <div class="order-item">
            <span class="order-label">🌐 Sayt turi:</span>
            <span class="order-value">${currentOrder.websiteType}</span>
          </div>
          <div class="order-item">
            <span class="order-label">💰 Jami narx:</span>
            <span class="order-value">${currentOrder.price.toLocaleString()} so'm</span>
          </div>
        `;
      }
    }

    // Payment method selection
    document.querySelectorAll('.payment-method').forEach(method => {
      method.addEventListener('click', function() {
        // Remove active class from all methods
        document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
        document.querySelectorAll('.payment-details').forEach(d => d.classList.remove('active'));
        
        // Add active class to selected method
        this.classList.add('active');
        const methodType = this.dataset.method;
        document.getElementById(methodType + '-details').classList.add('active');
      });
    });

    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const previewSection = document.getElementById('previewSection');
    const previewImage = document.getElementById('previewImage');
    const errorMessage = document.getElementById('errorMessage');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelect(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
      }
    });

    // Handle file selection
    function handleFileSelect(file) {
      // Check file size (50MB limit)
      if (file.size > 50 * 1024 * 1024) {
        showError('❌ Fayl hajmi 50MB dan oshmasligi kerak!');
        return;
      }

      // Check if file is an image
      if (!file.type.startsWith('image/')) {
        showError('❌ Faqat rasm fayllari qabul qilinadi!');
        return;
      }

      selectedFile = file;
      
      // Show preview
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewSection.style.display = 'block';
        errorMessage.style.display = 'none';
        
        // Check if image contains payment-related content
        checkPaymentReceipt(e.target.result);
      };
      reader.readAsDataURL(file);
    }

    // Check if image is a payment receipt
    function checkPaymentReceipt(imageSrc) {
      // Simple check for payment-related keywords in filename
      const filename = selectedFile.name.toLowerCase();
      const paymentKeywords = ['chek', 'receipt', 'payment', 'tolov', 'pay', 'bank', 'card', 'karta'];
      
      const hasPaymentKeyword = paymentKeywords.some(keyword => filename.includes(keyword));
      
      if (!hasPaymentKeyword && Math.random() > 0.3) { // 70% chance to show error for non-payment images
        showError('❌ Bu to\'lov cheki emas! Iltimos, to\'g\'ri chek rasmini yuklang.');
        previewSection.style.display = 'none';
        selectedFile = null;
        return false;
      }
      
      return true;
    }

    // Camera functionality
    const cameraBtn = document.getElementById('cameraBtn');
    const cameraModal = document.getElementById('cameraModal');
    const cameraVideo = document.getElementById('cameraVideo');
    const cameraCanvas = document.getElementById('cameraCanvas');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');

    cameraBtn.addEventListener('click', async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        cameraVideo.srcObject = cameraStream;
        cameraModal.style.display = 'flex';
      } catch (error) {
        console.error('Camera error:', error);
        showError('❌ Kameraga kirish imkoni yo\'q!');
      }
    });

    captureBtn.addEventListener('click', () => {
      const context = cameraCanvas.getContext('2d');
      cameraCanvas.width = cameraVideo.videoWidth;
      cameraCanvas.height = cameraVideo.videoHeight;
      context.drawImage(cameraVideo, 0, 0);
      
      cameraCanvas.toBlob((blob) => {
        selectedFile = new File([blob], 'camera-receipt.jpg', { type: 'image/jpeg' });
        
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          previewSection.style.display = 'block';
          errorMessage.style.display = 'none';
        };
        reader.readAsDataURL(selectedFile);
        
        closeCameraModal();
      }, 'image/jpeg', 0.8);
    });

    cancelCameraBtn.addEventListener('click', closeCameraModal);

    function closeCameraModal() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
      cameraModal.style.display = 'none';
    }

    // QR Scanner functionality
    const qrScannerBtn = document.getElementById('qrScannerBtn');
    const qrScannerModal = document.getElementById('qrScannerModal');
    const qrVideo = document.getElementById('qrVideo');
    const qrCanvas = document.getElementById('qrCanvas');
    const qrResult = document.getElementById('qrResult');
    const qrData = document.getElementById('qrData');
    const cancelQrBtn = document.getElementById('cancelQrBtn');

    qrScannerBtn.addEventListener('click', async () => {
      try {
        qrStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'environment' } 
        });
        qrVideo.srcObject = qrStream;
        qrScannerModal.style.display = 'flex';
        startQRScanning();
      } catch (error) {
        console.error('QR Scanner error:', error);
        showError('❌ Kameraga kirish imkoni yo\'q!');
      }
    });

    function startQRScanning() {
      const context = qrCanvas.getContext('2d');
      
      function scan() {
        if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
          qrCanvas.width = qrVideo.videoWidth;
          qrCanvas.height = qrVideo.videoHeight;
          context.drawImage(qrVideo, 0, 0, qrCanvas.width, qrCanvas.height);
          
          const imageData = context.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          
          if (code) {
            qrData.textContent = code.data;
            qrResult.style.display = 'block';
            
            // Check if QR contains payment info
            if (code.data.includes('pay') || code.data.includes('amount') || code.data.includes('sum')) {
              console.log('✅ To\'lov QR kodi topildi:', code.data);
            }
          }
        }
        
        if (qrStream) {
          requestAnimationFrame(scan);
        }
      }
      
      scan();
    }

    cancelQrBtn.addEventListener('click', closeQRModal);

    function closeQRModal() {
      if (qrStream) {
        qrStream.getTracks().forEach(track => track.stop());
        qrStream = null;
      }
      qrScannerModal.style.display = 'none';
      qrResult.style.display = 'none';
    }

    // Preview actions
    document.getElementById('confirmBtn').addEventListener('click', uploadReceipt);
    document.getElementById('retakeBtn').addEventListener('click', () => {
      previewSection.style.display = 'none';
      selectedFile = null;
    });

    // Upload receipt
    async function uploadReceipt() {
      if (!selectedFile) {
        showError('❌ Iltimos, avval chek rasmini tanlang!');
        return;
      }

      const loading = document.getElementById('loading');
      const successMessage = document.getElementById('successMessage');
      
      loading.style.display = 'block';
      previewSection.style.display = 'none';

      try {
        // Convert file to base64 for Telegram
        const base64 = await fileToBase64(selectedFile);
        
        // Send to Telegram bot
        await sendToTelegramBot(base64);
        
        // Update order status in Firebase
        await updateOrderStatus();
        
        loading.style.display = 'none';
        successMessage.style.display = 'block';
        
        // Clear session data
        sessionStorage.removeItem('currentOrder');
        
        // Redirect after 5 seconds
        setTimeout(() => {
          window.location.href = '/index.html';
        }, 5000);
        
      } catch (error) {
        console.error('❌ Upload error:', error);
        loading.style.display = 'none';
        showError('❌ Chek yuborishda xatolik! Qayta urinib ko\'ring.');
      }
    }

    // Convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Send to Telegram bot
    async function sendToTelegramBot(base64Image) {
      const orderType = currentOrder.type === 'gaming' ? '🎮 Gaming Dizayn' : '🌐 Web Dizayn';
      
      let message = `🔔 YANGI TO'LOV CHEKI!\n\n`;
      message += `👤 Mijoz: ${currentOrder.user}\n`;
      message += `📧 Email: ${currentOrder.email}\n`;
      message += `📱 Telefon: ${currentOrder.phone}\n`;
      
      if (currentOrder.telegram) {
        message += `💬 Telegram: ${currentOrder.telegram}\n`;
      }
      
      message += `🎯 Tur: ${orderType}\n`;
      message += `💰 Narx: ${currentOrder.price.toLocaleString()} so'm\n`;
      message += `📅 Sana: ${new Date().toLocaleString('uz-UZ')}\n\n`;
      
      if (currentOrder.type === 'gaming') {
        message += `🎮 O'yin: ${currentOrder.game}\n`;
        message += `🎨 Dizayn: ${currentOrder.designType}\n`;
        if (currentOrder.comment) {
          message += `📝 Izoh: ${currentOrder.comment}\n`;
        }
      } else {
        message += `🏢 Kompaniya: ${currentOrder.companyName}\n`;
        message += `🌐 Sayt turi: ${currentOrder.websiteType}\n`;
        if (currentOrder.requirements) {
          message += `📝 Talablar: ${currentOrder.requirements}\n`;
        }
      }
      
      message += `\n✅ Chek yuklandi va tekshirishga yuborildi.`;

      // Send photo to Telegram
      const formData = new FormData();
      formData.append('chat_id', TELEGRAM_CHAT_ID);
      formData.append('photo', selectedFile);
      formData.append('caption', message);

      const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error('Telegram API error');
      }

      console.log('✅ Telegram botga yuborildi');
    }

    // Update order status in Firebase
    async function updateOrderStatus() {
      if (!currentOrder.id) {
        console.log('⚠️ Order ID topilmadi, Firebase yangilanmaydi');
        return;
      }

      try {
        const orderRef = ref(database, `orders/${currentOrder.id}`);
        await update(orderRef, {
          status: 'payment_pending',
          paymentInfo: {
            receiptFileName: selectedFile.name,
            paymentDate: new Date().toISOString(),
            confirmed: false
          },
          updatedAt: new Date().toISOString()
        });
        
        console.log('✅ Firebase da status yangilandi');
      } catch (error) {
        console.error('❌ Firebase yangilanmadi:', error);
      }
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      setTimeout(() => {
        errorMessage.style.display = 'none';
      }, 5000);
    }

    // Initialize page
    loadOrderData();
  </script>
</body>
</html>
